#!/bin/bash
# Spotify Now-Playing commit trailer
# Appends the currently playing Spotify track to commit messages.
# Uses the CLI for token refresh. Skips silently for work repos or when nothing is playing.

COMMIT_MSG_FILE="$1"
COMMIT_SOURCE="$2"  # message, template, merge, squash, commit

append_track_trailer() {
    local track_info="$1"
    local captured_at

    local display="${track_info%%|*}"
    local remainder="${track_info#*|}"
    local album="${remainder%%|*}"
    local url="${remainder##*|}"
    captured_at=$(date '+%Y-%m-%d %H:%M:%S %Z')

    printf "\n\nðŸŽµ Now playing: %s\n" "$display" >> "$COMMIT_MSG_FILE"
    if [ -n "$album" ]; then
        printf "ðŸ’¿ Album: %s\n" "$album" >> "$COMMIT_MSG_FILE"
    fi
    printf "ðŸ”— Track: %s\n" "$url" >> "$COMMIT_MSG_FILE"
    printf "ðŸ•’ Captured: %s\n" "$captured_at" >> "$COMMIT_MSG_FILE"
}

pick_less_repeated_track() {
    local track_info="$1"
    local current_url="${track_info##*|}"
    local recent_json
    local alt_track
    local last_urls

    last_urls=$(git log --format=%B -n 20 | grep -oE 'https://open\.spotify\.com/track/[A-Za-z0-9]+' | head -n 8 | tr '\n' ' ')

    if [ -z "$last_urls" ] || ! echo " $last_urls " | grep -q " $current_url "; then
        printf "%s" "$track_info"
        return 0
    fi

    recent_json=$($SPOTIFY recent --limit=20 --json 2>/dev/null || true)
    if [ -z "$recent_json" ]; then
        printf "%s" "$track_info"
        return 0
    fi

    alt_track=$(CURRENT_URL="$current_url" LAST_URLS="$last_urls" RECENT_JSON="$recent_json" python3 - <<'PY'
import json
import os

current_url = os.environ.get("CURRENT_URL", "")
last_urls = {u for u in os.environ.get("LAST_URLS", "").split() if u}

try:
    items = json.loads(os.environ.get("RECENT_JSON", "[]"))
except Exception:
    items = []

for item in items:
    uri = item.get("uri", "")
    if not uri.startswith("spotify:track:"):
        continue
    track_id = uri.split(":")[-1]
    if not track_id:
        continue
    url = f"https://open.spotify.com/track/{track_id}"
    if url == current_url or url in last_urls:
        continue

    name = item.get("name", "")
    if not name:
        continue
    artist = item.get("artist", "")
    album = item.get("album", "")
    print(f"{artist} - {name}|{album}|{url}")
    break
PY
)

    if [ -n "$alt_track" ]; then
        printf "%s" "$alt_track"
    else
        printf "%s" "$track_info"
    fi
}

# Don't duplicate if a Spotify track URL already exists
if grep -qE 'https://open\.spotify\.com/track/[A-Za-z0-9]+' "$COMMIT_MSG_FILE"; then
    exit 0
fi

# Only run on fresh commits (not amends, merges, squashes)
if [ "$COMMIT_SOURCE" = "merge" ] || [ "$COMMIT_SOURCE" = "squash" ] || [ "$COMMIT_SOURCE" = "commit" ]; then
    exit 0
fi

# Safety: never run on work repos
REMOTE_URL=$(git remote get-url origin 2>/dev/null || echo "")
if echo "$REMOTE_URL" | grep -qiE "pstrax"; then
    exit 0
fi

# Find the spotify CLI â€” check repo first, then PATH
REPO_DIR="$(git rev-parse --show-toplevel 2>/dev/null)"
if [ -f "$REPO_DIR/spotify" ]; then
    SPOTIFY="php $REPO_DIR/spotify"
elif command -v spotify &>/dev/null; then
    SPOTIFY="spotify"
else
    # Fallback: try the raw API approach (no token refresh)
    TOKEN_FILE="$HOME/.config/spotify-cli/token.json"
    if [ ! -f "$TOKEN_FILE" ]; then
        exit 0
    fi

    ACCESS_TOKEN=$(python3 -c "
import json, sys, time
try:
    d = json.load(open('$TOKEN_FILE'))
    t = d.get('access_token', '')
    exp = d.get('expires_at', 0)
    if t and exp > time.time():
        print(t)
except:
    pass
" 2>/dev/null)

    if [ -z "$ACCESS_TOKEN" ]; then
        exit 0
    fi

    RESPONSE=$(curl -sf --max-time 3 \
        -H "Authorization: Bearer $ACCESS_TOKEN" \
        "https://api.spotify.com/v1/me/player/currently-playing" 2>/dev/null)

    if [ -z "$RESPONSE" ]; then
        exit 0
    fi

    TRACK_INFO=$(python3 -c "
import json, sys
try:
    d = json.loads('''$RESPONSE''')
    if not d.get('is_playing'):
        sys.exit(1)
    item = d.get('item', {})
    if not item:
        sys.exit(1)
    name = item.get('name', '')
    artist = item.get('artists', [{}])[0].get('name', '')
    album = item.get('album', {}).get('name', '')
    track_id = item.get('id', '')
    url = f'https://open.spotify.com/track/{track_id}'
    print(f'{artist} - {name}|{album}|{url}')
except:
    sys.exit(1)
" 2>/dev/null)

    if [ -z "$TRACK_INFO" ]; then
        exit 0
    fi

    append_track_trailer "$TRACK_INFO"
    exit 0
fi

# Use the CLI â€” handles token refresh automatically
JSON=$($SPOTIFY current --json 2>/dev/null)

if [ -z "$JSON" ]; then
    exit 0
fi

TRACK_INFO=$(python3 -c "
import json, sys
try:
    d = json.loads('''$JSON''')
    if not d.get('is_playing'):
        sys.exit(1)
    name = d.get('name') or d.get('track', '')
    artist = d.get('artist', '')
    album = d.get('album', '')
    uri = d.get('uri', '')
    # Extract track ID from uri (spotify:track:XXXXX)
    track_id = uri.split(':')[-1] if uri else ''
    if not name or not track_id:
        sys.exit(1)
    url = f'https://open.spotify.com/track/{track_id}'
    print(f'{artist} - {name}|{album}|{url}')
except:
    sys.exit(1)
" 2>/dev/null)

if [ -z "$TRACK_INFO" ]; then
    exit 0
fi

TRACK_INFO=$(pick_less_repeated_track "$TRACK_INFO")

# Append as a git trailer (blank line + trailer)
append_track_trailer "$TRACK_INFO"
